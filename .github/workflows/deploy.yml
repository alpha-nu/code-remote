# Continuous Deployment - deploys to AWS on release branch pushes
name: Deploy

on:
  push:
    branches:
      - 'release/dev'
      - 'release/staging'
      - 'release/prod'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: us-east-1
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

jobs:
  # Determine which environment to deploy to
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      stack: ${{ steps.env.outputs.stack }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="${GITHUB_REF#refs/heads/release/}"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "stack=code-remote-$ENV" >> $GITHUB_OUTPUT
          echo "Deploying to: $ENV"

  # Run all tests before deploying
  test:
    name: Pre-deploy Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Test Backend
        working-directory: backend
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"
          pytest tests/unit/ -v

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Test Frontend
        working-directory: frontend
        run: |
          npm ci
          npm run lint
          npm run test

  # Deploy infrastructure with Pulumi
  infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [setup, test]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      ecr_repository_url: ${{ steps.outputs.outputs.ecr_repository_url }}
      eks_cluster_name: ${{ steps.outputs.outputs.eks_cluster_name }}
      api_endpoint: ${{ steps.outputs.outputs.api_endpoint }}
      frontend_bucket_name: ${{ steps.outputs.outputs.frontend_bucket_name }}
      frontend_distribution_id: ${{ steps.outputs.outputs.frontend_distribution_id }}
      frontend_url: ${{ steps.outputs.outputs.frontend_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Pulumi
        uses: pulumi/actions@v5

      - name: Install dependencies
        working-directory: infra/pulumi
        run: pip install -r requirements.txt

      - name: Select Pulumi stack
        working-directory: infra/pulumi
        run: |
          pulumi stack select ${{ needs.setup.outputs.stack }} --create

      - name: Pulumi preview
        working-directory: infra/pulumi
        run: pulumi preview --stack ${{ needs.setup.outputs.stack }}

      - name: Pulumi up
        working-directory: infra/pulumi
        run: pulumi up --yes --stack ${{ needs.setup.outputs.stack }}

      - name: Get Pulumi outputs
        id: outputs
        working-directory: infra/pulumi
        run: |
          echo "ecr_repository_url=$(pulumi stack output ecr_api_repository_url --stack ${{ needs.setup.outputs.stack }})" >> $GITHUB_OUTPUT
          echo "eks_cluster_name=$(pulumi stack output eks_cluster_name --stack ${{ needs.setup.outputs.stack }})" >> $GITHUB_OUTPUT
          echo "api_endpoint=$(pulumi stack output api_endpoint --stack ${{ needs.setup.outputs.stack }} 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "frontend_bucket_name=$(pulumi stack output frontend_bucket_name --stack ${{ needs.setup.outputs.stack }})" >> $GITHUB_OUTPUT
          echo "frontend_distribution_id=$(pulumi stack output frontend_distribution_id --stack ${{ needs.setup.outputs.stack }})" >> $GITHUB_OUTPUT
          echo "frontend_url=$(pulumi stack output frontend_url --stack ${{ needs.setup.outputs.stack }})" >> $GITHUB_OUTPUT

  # Build and push container images
  build-images:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: [setup, infrastructure]
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      api_image: ${{ steps.tags.outputs.api_image }}
      executor_image: ${{ steps.tags.outputs.executor_image }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tags
        id: tags
        run: |
          ECR_URL="${{ needs.infrastructure.outputs.ecr_repository_url }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          echo "api_image=${ECR_URL}/api:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "executor_image=${ECR_URL}/executor:${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          target: production
          push: true
          tags: |
            ${{ steps.tags.outputs.api_image }}
            ${{ needs.infrastructure.outputs.ecr_repository_url }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Executor image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.executor
          push: true
          tags: |
            ${{ steps.tags.outputs.executor_image }}
            ${{ needs.infrastructure.outputs.ecr_repository_url }}/executor:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to Kubernetes
  deploy-k8s:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, build-images]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ needs.infrastructure.outputs.eks_cluster_name }} \
            --region ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'

      - name: Deploy with Kustomize
        env:
          ENVIRONMENT: ${{ needs.setup.outputs.environment }}
          API_IMAGE: ${{ needs.build-images.outputs.api_image }}
          EXECUTOR_IMAGE: ${{ needs.build-images.outputs.executor_image }}
        run: |
          cd kubernetes/overlays/$ENVIRONMENT

          # Update image references using kustomize edit
          kustomize edit set image api-placeholder=$API_IMAGE
          kustomize edit set image executor-placeholder=$EXECUTOR_IMAGE

          # Apply the manifests
          kubectl apply -k .

          # Wait for rollout
          kubectl rollout status deployment/api -n code-remote --timeout=300s
          kubectl rollout status deployment/executor -n code-remote --timeout=300s

      - name: Verify deployment
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n code-remote

          echo "=== Services ==="
          kubectl get svc -n code-remote

          echo "=== API Health Check ==="
          # Get the API service endpoint
          kubectl run health-check --rm -i --restart=Never \
            --image=curlimages/curl:latest \
            -n code-remote \
            -- curl -s http://api.code-remote.svc.cluster.local/health || true

  # Deploy frontend to S3 + CloudFront
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [setup, infrastructure]
    environment: ${{ needs.setup.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_URL: ${{ needs.infrastructure.outputs.api_endpoint }}
          VITE_COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
          VITE_COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
          VITE_COGNITO_REGION: ${{ env.AWS_REGION }}
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        working-directory: frontend
        run: |
          aws s3 sync dist/ s3://${{ needs.infrastructure.outputs.frontend_bucket_name }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

          # Upload index.html and JSON with shorter cache
          aws s3 cp dist/index.html s3://${{ needs.infrastructure.outputs.frontend_bucket_name }}/index.html \
            --cache-control "public, max-age=0, must-revalidate"

          # Upload any JSON config files with no cache
          find dist -name "*.json" -exec aws s3 cp {} s3://${{ needs.infrastructure.outputs.frontend_bucket_name }}/$(basename {}) \
            --cache-control "public, max-age=0, must-revalidate" \; 2>/dev/null || true

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.infrastructure.outputs.frontend_distribution_id }} \
            --paths "/index.html" "/*.json"

      - name: Output frontend URL
        run: |
          echo "## Frontend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ needs.infrastructure.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY

  # Run smoke tests after deployment
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, deploy-k8s, deploy-frontend]
    environment: ${{ needs.setup.outputs.environment }}
    if: needs.setup.outputs.environment != 'prod'
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Run smoke tests
        working-directory: backend
        env:
          API_ENDPOINT: ${{ needs.infrastructure.outputs.api_endpoint }}
          ENVIRONMENT: ${{ needs.setup.outputs.environment }}
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

          # Run smoke tests if endpoint is available
          if [ -n "$API_ENDPOINT" ]; then
            pytest tests/smoke/ -v --api-url="$API_ENDPOINT" || echo "Smoke tests skipped - endpoint not accessible"
          else
            echo "Skipping smoke tests - no API endpoint available"
          fi

  # Notify on completion
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [setup, infrastructure, deploy-k8s, deploy-frontend, smoke-tests]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ needs.infrastructure.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-k8s.result }}" = "success" ] && [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
            echo "✅ Deployment successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Deployment failed!" >> $GITHUB_STEP_SUMMARY
          fi
