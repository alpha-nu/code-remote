apiVersion: apps/v1
kind: Deployment
metadata:
  name: executor
  labels:
    app.kubernetes.io/name: executor
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: executor
  template:
    metadata:
      labels:
        app.kubernetes.io/name: executor
    spec:
      # Use gVisor for kernel isolation
      runtimeClassName: gvisor
      # Run on executor nodes only (with taints)
      nodeSelector:
        workload: executor
      tolerations:
        - key: workload
          operator: Equal
          value: executor
          effect: NoSchedule
      containers:
        - name: executor
          image: executor-placeholder:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8001
              protocol: TCP
          env:
            - name: EXECUTION_TIMEOUT_SECONDS
              value: "30"
            - name: MAX_CODE_SIZE_BYTES
              value: "10240"
          resources:
            # Strict limits for sandbox
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 100m      # Hard limit - no bursting
              memory: 256Mi  # Hard limit - OOM kill if exceeded
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534  # nobody
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          # No probes - executor is stateless and ephemeral
      securityContext:
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
      # Don't mount service account token
      automountServiceAccountToken: false
